<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deriv Advanced Trading Bot - OAuth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        h1 {
            color: #fff;
            text-align: center;
            font-size: 2.5em;
            background: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        h3, h4 {
            color: #e0e0e0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-section {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .login-section h2 {
            margin-bottom: 20px;
            font-size: 1.8em;
            color: #fff;
        }

        .oauth-btn {
            background: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
            color: #0a0a0a;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .oauth-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 212, 255, 0.3);
        }

        .user-info {
            background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
            color: #e0e0e0;
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-bar {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            color: #e0e0e0;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: #00d4ff;
            border-bottom-color: #00d4ff;
        }

        .tab:hover {
            color: #00ff88;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .strategy-card {
            padding: 15px;
            border: 2px solid #333;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: rgba(40, 40, 40, 0.5);
        }

        .strategy-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
        }

        .strategy-card.active {
            border-color: #00ff88;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(0, 255, 136, 0.1) 100%);
        }

        .strategy-card h4 {
            color: #fff;
            margin-bottom: 5px;
        }

        .strategy-card p {
            font-size: 12px;
            color: #888;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            color: #aaa;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 13px;
        }

        input, select {
            padding: 10px;
            border: 2px solid #333;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s;
            background: #1a1a1a;
            color: #e0e0e0;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .digit-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .digit-btn {
            padding: 15px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #1a1a1a;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: bold;
            position: relative;
        }

        .digit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
        }

        .digit-btn.selected {
            background: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
            color: #0a0a0a;
            border-color: #00ff88;
        }

        .digit-heat {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ff4444;
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a9eff 0%, #00d4ff 100%);
            color: #0a0a0a;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4444 0%, #ff6b6b 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
            color: #0a0a0a;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 212, 255, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: rgba(40, 40, 40, 0.5);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #333;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
        }

        .stat-label {
            color: #888;
            margin-top: 5px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 20px;
            height: 400px;
            position: relative;
            border: 1px solid #333;
        }

        #profitChart {
            width: 100%;
            height: 100%;
        }

        .pattern-display {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #333;
        }

        .pattern-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(40, 40, 40, 0.5);
            border-radius: 5px;
            border: 1px solid #333;
        }

        .pattern-digits {
            display: flex;
            gap: 5px;
        }

        .pattern-digit {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
            color: #0a0a0a;
            border-radius: 5px;
            font-weight: bold;
        }

        .pattern-confidence {
            margin-left: auto;
            padding: 5px 10px;
            background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
            color: #0a0a0a;
            border-radius: 15px;
            font-size: 12px;
        }

        .trades-log {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
        }

        .trade-entry {
            background: rgba(40, 40, 40, 0.5);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #333;
            color: #e0e0e0;
        }

        .trade-entry.win {
            border-left-color: #00ff88;
        }

        .trade-entry.loss {
            border-left-color: #ff4444;
        }

        .backtest-results {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #333;
        }

        .backtest-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(40, 40, 40, 0.5);
            border-radius: 5px;
            color: #e0e0e0;
        }

        .risk-meter {
            height: 30px;
            background: #1a1a1a;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            border: 1px solid #333;
        }

        .risk-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0a0a0a;
            font-weight: bold;
        }

        .risk-low { background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%); }
        .risk-medium { background: linear-gradient(135deg, #ffaa00 0%, #ff6b6b 100%); }
        .risk-high { background: linear-gradient(135deg, #ff4444 0%, #ff0000 100%); }

        .hidden {
            display: none !important;
        }

        .loading-spinner {
            border: 3px solid #333;
            border-top: 3px solid #00d4ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .strategy-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .digit-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .strategy-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .digit-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
    <!-- Chart.js for advanced charting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>🎯 Deriv Advanced Trading Bot</h1>
            
            <!-- Login Section -->
            <div id="loginSection" class="login-section">
                <h2>Welcome to Advanced Trading</h2>
                <p>Sign in with your Deriv account to start automated trading with advanced strategies</p>
                <button class="oauth-btn" id="loginBtn">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                    </svg>
                    Sign in with Deriv
                </button>
                <div id="loadingSpinner" class="loading-spinner hidden"></div>
            </div>

            <!-- User Info (Hidden until logged in) -->
            <div id="userSection" class="hidden">
                <div class="user-info">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #667eea; font-weight: bold;" id="userAvatar">U</div>
                        <div>
                            <div id="userName">User</div>
                            <div style="font-size: 12px; opacity: 0.9;" id="userEmail">user@email.com</div>
                        </div>
                    </div>
                    <button class="btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%); padding: 8px 20px; font-size: 12px;" id="logoutBtn">Logout</button>
                </div>
            </div>
        </div>

        <!-- Main Trading Interface (Hidden until logged in) -->
        <div id="tradingInterface" class="hidden">
            <div class="dashboard-grid">
                <!-- Left Panel - Configuration -->
                <div class="left-panel">
                    <!-- Strategy Selection -->
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">Trading Strategies</h3>
                        <div class="strategy-grid">
                            <div class="strategy-card" data-strategy="manual">
                                <h4>Manual</h4>
                                <p>Choose your own digits</p>
                            </div>
                            <div class="strategy-card" data-strategy="martingale">
                                <h4>Martingale</h4>
                                <p>Double after loss</p>
                            </div>
                            <div class="strategy-card" data-strategy="anti-martingale">
                                <h4>Anti-Martingale</h4>
                                <p>Double after win</p>
                            </div>
                            <div class="strategy-card" data-strategy="even-odd">
                                <h4>Even/Odd</h4>
                                <p>Alternate patterns</p>
                            </div>
                            <div class="strategy-card" data-strategy="pattern">
                                <h4>Pattern AI</h4>
                                <p>ML predictions</p>
                            </div>
                            <div class="strategy-card" data-strategy="hot-cold">
                                <h4>Hot/Cold</h4>
                                <p>Frequency based</p>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration -->
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">Configuration</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="market">Market</label>
                                <select id="market">
                                    <option value="R_10">Volatility 10</option>
                                    <option value="R_25">Volatility 25</option>
                                    <option value="R_50">Volatility 50</option>
                                    <option value="R_75">Volatility 75</option>
                                    <option value="R_100">Volatility 100</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="stake">Initial Stake ($)</label>
                                <input type="number" id="stake" value="1" min="0.35" max="50000" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="duration">Duration</label>
                                <input type="number" id="duration" value="1" min="1" max="10">
                            </div>
                            <div class="form-group">
                                <label for="maxTrades">Max Trades</label>
                                <input type="number" id="maxTrades" value="20" min="1" max="1000">
                            </div>
                            <div class="form-group">
                                <label for="stopLoss">Stop Loss ($)</label>
                                <input type="number" id="stopLoss" value="50" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label for="takeProfit">Take Profit ($)</label>
                                <input type="number" id="takeProfit" value="100" min="0" step="1">
                            </div>
                            
                            <!-- Martingale Settings -->
                            <div id="martingaleSettings" class="form-group full-width hidden">
                                <label for="martingaleMultiplier">Martingale Multiplier</label>
                                <input type="number" id="martingaleMultiplier" value="2" min="1.1" max="10" step="0.1">
                            </div>
                            
                            <!-- Pattern Settings -->
                            <div id="patternSettings" class="form-group full-width hidden">
                                <label for="patternLength">Pattern Length</label>
                                <input type="number" id="patternLength" value="5" min="3" max="10">
                            </div>
                        </div>

                        <!-- Digit Selection -->
                        <div id="digitSelection" style="margin-top: 20px;">
                            <label style="display: block; margin-bottom: 10px;">Select Digits:</label>
                            <div class="digit-grid">
                                <button class="digit-btn" data-digit="0">
                                    0
                                    <span class="digit-heat hidden">0</span>
                                </button>
                                <button class="digit-btn" data-digit="1">
                                    1
                                    <span class="digit-heat hidden">0</span>
                                </button>
                                <button class="digit-btn" data-digit="2">
                                    2
                                    <span class="digit-heat hidden">0</span>
                                </button>
                                <button class="digit-btn" data-digit="3">
                                    3
                                    <span class="digit-heat hidden">0</span>
                                </button>
                                <button class="digit-btn" data-digit="4">
                                    4
                                    <span class="digit-heat hidden">0</span>
                                </button>
                                <button class="digit-btn" data-digit="5">
                                    5
                                    <span class="digit-heat hidden">0</span>
                                </button>
                                <button class="digit-btn" data-digit="6">
                                    6
                                    <span class="digit-heat hidden">0</span>
                                </button>
                                <button class="digit-btn" data-digit="7">
                                    7
                                    <span class="digit-heat hidden">0</span>
                                </button>
                                <button class="digit-btn" data-digit="8">
                                    8
                                    <span class="digit-heat hidden">0</span>
                                </button>
                                <button class="digit-btn" data-digit="9">
                                    9
                                    <span class="digit-heat hidden">0</span>
                                </button>
                            </div>
                        </div>

                        <div class="control-buttons">
                            <button class="btn btn-success" id="startBtn">Start Bot</button>
                            <button class="btn btn-danger" id="stopBtn" disabled>Stop Bot</button>
                            <button class="btn btn-primary" id="backtestBtn">Backtest</button>
                        </div>
                    </div>

                    <!-- Risk Calculator -->
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">Risk Assessment</h3>
                        <div class="risk-meter">
                            <div class="risk-fill risk-low" id="riskMeter" style="width: 30%">
                                Low Risk
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                            <span>Max Loss: <strong id="maxLoss">$0</strong></span>
                            <span>Win Rate Needed: <strong id="breakEven">50%</strong></span>
                            <span>Kelly %: <strong id="kellyPercent">0%</strong></span>
                        </div>
                    </div>
                </div>

                <!-- Right Panel - Charts and Analytics -->
                <div class="right-panel">
                    <!-- Status Bar -->
                    <div class="card">
                        <div class="status-bar">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="width: 12px; height: 12px; border-radius: 50%; background: #44ff44;" id="statusDot"></span>
                                <span id="connectionStatus">Connected</span>
                            </div>
                            <div>
                                <span>Balance: </span>
                                <strong id="balance">$0.00</strong>
                            </div>
                            <div>
                                <span>Strategy: </span>
                                <strong id="activeStrategy">Manual</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="card">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="totalTrades">0</div>
                                <div class="stat-label">Total Trades</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="winRate">0%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="profit">$0.00</div>
                                <div class="stat-label">Profit/Loss</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="sharpeRatio">0.00</div>
                                <div class="stat-label">Sharpe Ratio</div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Tabs -->
                    <div class="card">
                        <div class="tabs">
                            <button class="tab active" data-tab="profit">Profit Chart</button>
                            <button class="tab" data-tab="distribution">Digit Distribution</button>
                            <button class="tab" data-tab="patterns">Patterns</button>
                            <button class="tab" data-tab="backtest">Backtest</button>
                        </div>

                        <!-- Profit Chart Tab -->
                        <div class="tab-content active" id="profit-tab">
                            <div class="chart-container">
                                <canvas id="profitChart"></canvas>
                            </div>
                        </div>

                        <!-- Distribution Tab -->
                        <div class="tab-content" id="distribution-tab">
                            <div class="chart-container">
                                <canvas id="distributionChart"></canvas>
                            </div>
                        </div>

                        <!-- Patterns Tab -->
                        <div class="tab-content" id="patterns-tab">
                            <div class="pattern-display">
                                <h4>Detected Patterns</h4>
                                <div id="patternsList"></div>
                            </div>
                        </div>

                        <!-- Backtest Tab -->
                        <div class="tab-content" id="backtest-tab">
                            <div class="backtest-results">
                                <h4>Backtest Results</h4>
                                <div class="backtest-metric">
                                    <span>Total Return</span>
                                    <strong id="btReturn">0%</strong>
                                </div>
                                <div class="backtest-metric">
                                    <span>Max Drawdown</span>
                                    <strong id="btDrawdown">0%</strong>
                                </div>
                                <div class="backtest-metric">
                                    <span>Win Rate</span>
                                    <strong id="btWinRate">0%</strong>
                                </div>
                                <div class="backtest-metric">
                                    <span>Profit Factor</span>
                                    <strong id="btProfitFactor">0.00</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trade History -->
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">Trade History</h3>
                        <div class="trades-log">
                            <div id="tradesList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // OAuth Configuration
        const OAUTH_CONFIG = {
            app_id: '100314', // Your Deriv OAuth app_id
            oauth_url: 'https://oauth.deriv.com/oauth2/authorize',
            redirect_uri: window.location.origin + window.location.pathname,
            ws_url: 'wss://ws.derivws.com/websockets/v3'
        };

        // Bot State
        let ws = null;
        let isConnected = false;
        let isRunning = false;
        let selectedDigits = new Set();
        let activeStrategy = 'manual';
        let accessToken = null;
        let userInfo = null;
        let currentStake = 1;
        let martingaleLevel = 0;
        
        // Statistics
        let stats = {
            totalTrades: 0,
            wins: 0,
            losses: 0,
            profit: 0,
            currentStreak: 0,
            initialBalance: 0,
            currentBalance: 0,
            maxDrawdown: 0,
            peakBalance: 0,
            returns: []
        };

        // Pattern Recognition
        let digitHistory = [];
        let digitFrequency = new Array(10).fill(0);
        let patterns = new Map();
        
        // Charts
        let profitChart = null;
        let distributionChart = null;
        let profitData = [];
        let tradeLabels = [];

        // Machine Learning Pattern Detection
        class PatternDetector {
            constructor() {
                this.patterns = new Map();
                this.minConfidence = 0.6;
            }

            addResult(digit) {
                digitHistory.push(digit);
                digitFrequency[digit]++;
                
                if (digitHistory.length > 100) {
                    digitHistory.shift();
                }
                
                this.detectPatterns();
            }

            detectPatterns() {
                const patternLength = parseInt(document.getElementById('patternLength')?.value || 5);
                
                if (digitHistory.length < patternLength * 2) return;
                
                // Look for repeating patterns
                for (let i = 0; i <= digitHistory.length - patternLength * 2; i++) {
                    const pattern = digitHistory.slice(i, i + patternLength).join('');
                    const nextPattern = digitHistory.slice(i + patternLength, i + patternLength * 2).join('');
                    
                    if (!this.patterns.has(pattern)) {
                        this.patterns.set(pattern, { count: 0, followed: new Map() });
                    }
                    
                    const patternData = this.patterns.get(pattern);
                    patternData.count++;
                    
                    if (nextPattern.length > 0) {
                        const nextDigit = nextPattern[0];
                        const followCount = patternData.followed.get(nextDigit) || 0;
                        patternData.followed.set(nextDigit, followCount + 1);
                    }
                }
            }

            getPrediction() {
                const patternLength = parseInt(document.getElementById('patternLength')?.value || 5);
                
                if (digitHistory.length < patternLength) return null;
                
                const currentPattern = digitHistory.slice(-patternLength).join('');
                const patternData = this.patterns.get(currentPattern);
                
                if (!patternData || patternData.count < 3) return null;
                
                let maxProb = 0;
                let prediction = null;
                
                for (let [digit, count] of patternData.followed) {
                    const prob = count / patternData.count;
                    if (prob > maxProb && prob >= this.minConfidence) {
                        maxProb = prob;
                        prediction = { digit: parseInt(digit), confidence: prob };
                    }
                }
                
                return prediction;
            }

            getTopPatterns(limit = 5) {
                const sortedPatterns = Array.from(this.patterns.entries())
                    .filter(([pattern, data]) => data.count >= 3)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, limit);
                
                return sortedPatterns.map(([pattern, data]) => {
                    const predictions = Array.from(data.followed.entries())
                        .sort((a, b) => b[1] - a[1]);
                    
                    return {
                        pattern: pattern.split('').join(' '),
                        count: data.count,
                        nextMostLikely: predictions[0] ? predictions[0][0] : null,
                        confidence: predictions[0] ? (predictions[0][1] / data.count) : 0
                    };
                });
            }
        }

        const patternDetector = new PatternDetector();

        // Strategy Functions
        const strategies = {
            manual: {
                getNextDigit: () => {
                    const digitsArray = Array.from(selectedDigits);
                    return digitsArray[Math.floor(Math.random() * digitsArray.length)];
                },
                onWin: () => {},
                onLoss: () => {},
                reset: () => {}
            },
            
            martingale: {
                getNextDigit: () => strategies.manual.getNextDigit(),
                onWin: () => {
                    currentStake = parseFloat(document.getElementById('stake').value);
                    martingaleLevel = 0;
                },
                onLoss: () => {
                    const multiplier = parseFloat(document.getElementById('martingaleMultiplier').value);
                    currentStake *= multiplier;
                    martingaleLevel++;
                    
                    // Safety limit
                    if (martingaleLevel > 5) {
                        currentStake = parseFloat(document.getElementById('stake').value);
                        martingaleLevel = 0;
                    }
                },
                reset: () => {
                    currentStake = parseFloat(document.getElementById('stake').value);
                    martingaleLevel = 0;
                }
            },
            
            'anti-martingale': {
                getNextDigit: () => strategies.manual.getNextDigit(),
                onWin: () => {
                    const multiplier = parseFloat(document.getElementById('martingaleMultiplier').value);
                    currentStake *= multiplier;
                    martingaleLevel++;
                    
                    if (martingaleLevel > 3) {
                        currentStake = parseFloat(document.getElementById('stake').value);
                        martingaleLevel = 0;
                    }
                },
                onLoss: () => {
                    currentStake = parseFloat(document.getElementById('stake').value);
                    martingaleLevel = 0;
                },
                reset: () => {
                    currentStake = parseFloat(document.getElementById('stake').value);
                    martingaleLevel = 0;
                }
            },
            
            'even-odd': {
                lastChoice: 'even',
                getNextDigit: function() {
                    const evenDigits = [0, 2, 4, 6, 8];
                    const oddDigits = [1, 3, 5, 7, 9];
                    
                    this.lastChoice = this.lastChoice === 'even' ? 'odd' : 'even';
                    const digits = this.lastChoice === 'even' ? evenDigits : oddDigits;
                    
                    return digits[Math.floor(Math.random() * digits.length)];
                },
                onWin: () => {},
                onLoss: () => {},
                reset: function() {
                    this.lastChoice = 'even';
                }
            },
            
            pattern: {
                getNextDigit: () => {
                    const prediction = patternDetector.getPrediction();
                    
                    if (prediction && prediction.confidence >= 0.6) {
                        return prediction.digit;
                    }
                    
                    // Fallback to random selection
                    return strategies.manual.getNextDigit();
                },
                onWin: () => {},
                onLoss: () => {},
                reset: () => {}
            },
            
            'hot-cold': {
                getNextDigit: () => {
                    // Get hot numbers (most frequent)
                    const sorted = digitFrequency
                        .map((count, digit) => ({ digit, count }))
                        .sort((a, b) => b.count - a.count);
                    
                    // Pick from top 3 hot numbers
                    const hotNumbers = sorted.slice(0, 3).map(item => item.digit);
                    return hotNumbers[Math.floor(Math.random() * hotNumbers.length)];
                },
                onWin: () => {},
                onLoss: () => {},
                reset: () => {
                    digitFrequency = new Array(10).fill(0);
                }
            }
        };

        // DOM Elements
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const backtestBtn = document.getElementById('backtestBtn');

        // Initialize Charts
        function initCharts() {
            // Profit Chart
            const profitCtx = document.getElementById('profitChart').getContext('2d');
            profitChart = new Chart(profitCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Profit/Loss',
                        data: [],
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            // Distribution Chart
            const distCtx = document.getElementById('distributionChart').getContext('2d');
            distributionChart = new Chart(distCtx, {
                type: 'bar',
                data: {
                    labels: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'],
                    datasets: [{
                        label: 'Frequency',
                        data: new Array(10).fill(0),
                        backgroundColor: 'rgba(102, 126, 234, 0.5)',
                        borderColor: 'rgb(102, 126, 234)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Tab Switching
        document.addEventListener('DOMContentLoaded', () => {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabContent = document.getElementById(`${tab.dataset.tab}-tab`);
                    if (tabContent) tabContent.classList.add('active');
                });
            });

            // Strategy Selection
            document.querySelectorAll('.strategy-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.strategy-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    activeStrategy = card.dataset.strategy;
                    const strategyName = card.querySelector('h4');
                    if (strategyName) {
                        const activeStrategyEl = document.getElementById('activeStrategy');
                        if (activeStrategyEl) activeStrategyEl.textContent = strategyName.textContent;
                    }
                    
                    // Show/hide strategy-specific settings
                    const martingaleSettings = document.getElementById('martingaleSettings');
                    const patternSettings = document.getElementById('patternSettings');
                    const digitSelection = document.getElementById('digitSelection');
                    
                    if (martingaleSettings) {
                        martingaleSettings.classList.toggle('hidden', 
                            !['martingale', 'anti-martingale'].includes(activeStrategy));
                    }
                    if (patternSettings) {
                        patternSettings.classList.toggle('hidden', 
                            activeStrategy !== 'pattern');
                    }
                    if (digitSelection) {
                        digitSelection.classList.toggle('hidden',
                            !['manual', 'martingale', 'anti-martingale'].includes(activeStrategy));
                    }
                });
            });

            // Digit Selection
            document.querySelectorAll('.digit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const digit = btn.dataset.digit;
                    if (selectedDigits.has(digit)) {
                        selectedDigits.delete(digit);
                        btn.classList.remove('selected');
                    } else {
                        selectedDigits.add(digit);
                        btn.classList.add('selected');
                    }
                });
            });
        });

        // OAuth Login
        loginBtn.addEventListener('click', () => {
            // Check if demo mode is requested (hold Shift while clicking)
            if (event.shiftKey) {
                // Demo mode - bypass OAuth
                activateDemoMode();
                return;
            }
            
            const state = generateRandomString(16);
            sessionStorage.setItem('oauth_state', state);
            
            const params = new URLSearchParams({
                app_id: OAUTH_CONFIG.app_id,
                response_type: 'code',
                redirect_uri: OAUTH_CONFIG.redirect_uri,
                state: state,
                scope: 'read,trade,payments,admin'
            });
            
            // For local testing, show instructions
            if (window.location.protocol === 'file:' || window.location.hostname === 'localhost') {
                alert('OAuth requires a web server. Use Demo Mode instead:\n\n' +
                      '1. Hold Shift + Click "Sign in with Deriv" for Demo Mode\n' +
                      '2. Or host this file on a web server and register with Deriv\n\n' +
                      'Demo Mode gives you full functionality with simulated trades.');
                return;
            }
            
            window.location.href = `${OAUTH_CONFIG.oauth_url}?${params.toString()}`;
        });

        // Demo Mode Function
        function activateDemoMode() {
            console.log('Activating Demo Mode...');
            
            // Simulate successful login
            userInfo = {
                fullname: 'Demo Trader',
                email: 'demo@deriv.com',
                loginid: 'DEMO123'
            };
            
            isConnected = true;
            stats.currentBalance = 10000; // Start with $10,000 demo balance
            stats.initialBalance = 10000;
            stats.peakBalance = 10000;
            
            // Update UI
            document.getElementById('userName').textContent = userInfo.fullname;
            document.getElementById('userEmail').textContent = userInfo.email;
            document.getElementById('userAvatar').textContent = 'D';
            
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('tradingInterface').classList.remove('hidden');
            
            updateConnectionStatus(true);
            updateBalance(stats.currentBalance);
            
            // Show demo mode notification
            showDemoNotification();
            
            // Initialize demo WebSocket simulator
            initializeDemoMode();
        }

        // Demo Mode WebSocket Simulator
        function initializeDemoMode() {
            // Create a fake WebSocket-like object
            ws = {
                readyState: 1,
                send: function(message) {
                    const data = JSON.parse(message);
                    
                    // Simulate responses
                    setTimeout(() => {
                        if (data.proposal) {
                            // Simulate proposal response
                            handleMessage({
                                msg_type: 'proposal',
                                proposal: {
                                    id: Math.random().toString(36).substr(2, 9),
                                    ask_price: currentStake
                                }
                            });
                        } else if (data.buy) {
                            // Simulate buy response
                            const contractId = Math.random().toString(36).substr(2, 9);
                            handleMessage({
                                msg_type: 'buy',
                                buy: {
                                    contract_id: contractId,
                                    buy_price: currentStake
                                }
                            });
                            
                            // Simulate contract result after 2 seconds
                            setTimeout(() => {
                                const won = Math.random() < 0.5; // 50% win rate
                                const profit = won ? currentStake * 0.95 : -currentStake;
                                const lastDigit = Math.floor(Math.random() * 10);
                                
                                stats.currentBalance += profit;
                                
                                handleMessage({
                                    msg_type: 'proposal_open_contract',
                                    proposal_open_contract: {
                                        is_sold: true,
                                        contract_id: contractId,
                                        profit: profit,
                                        exit_tick: '1234567890.' + lastDigit
                                    }
                                });
                            }, 2000);
                        }
                    }, 500);
                },
                close: function() {
                    console.log('Demo mode disconnected');
                }
            };
        }

        function showDemoNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
                color: #0a0a0a;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.5s ease-out;
            `;
            notification.innerHTML = '🎮 Demo Mode Active - $10,000 Virtual Balance';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s ease-out';
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }

        logoutBtn.addEventListener('click', () => {
            logout();
        });

        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Check for OAuth callback
        window.addEventListener('load', () => {
            console.log('Page loaded. Current URL:', window.location.href);
            console.log('OAuth Config:', OAUTH_CONFIG);
            
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            // Check for OAuth errors
            if (error) {
                console.error('OAuth error:', error);
                alert('Authorization failed: ' + error);
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            if (code) {
                console.log('OAuth code found, processing...');
                handleOAuthCallback(code);
            } else {
                console.log('No OAuth code, checking for stored token...');
                checkStoredToken();
            }
            
            // Initialize charts after DOM is ready
            setTimeout(initCharts, 100);
            
            // Add debug info
            console.log('Bot initialized. App ID:', OAUTH_CONFIG.app_id);
            console.log('Redirect URI:', OAUTH_CONFIG.redirect_uri);
            
            // Add clear cache button handler
            const clearAuthBtn = document.getElementById('clearAuthBtn');
            if (clearAuthBtn) {
                clearAuthBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('deriv_access_token');
                    localStorage.removeItem('deriv_auth_time');
                    sessionStorage.removeItem('oauth_state');
                    alert('Authentication cache cleared. You can now sign in again.');
                    window.location.reload();
                });
            }
            
            // Add token login option
            const useTokenBtn = document.getElementById('useTokenBtn');
            if (useTokenBtn) {
                useTokenBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const token = prompt('Enter your Deriv API Token:\n\n' +
                        '1. Go to https://app.deriv.com/account/api-token\n' +
                        '2. Create a token with all permissions\n' +
                        '3. Copy and paste it here');
                    
                    if (token && token.trim()) {
                        accessToken = token.trim();
                        localStorage.setItem('deriv_access_token', accessToken);
                        localStorage.setItem('deriv_auth_time', Date.now().toString());
                        connectWithToken(accessToken);
                    }
                });
            }
        });

        async function handleOAuthCallback(code) {
            const state = new URLSearchParams(window.location.search).get('state');
            const storedState = sessionStorage.getItem('oauth_state');
            
            if (!state || state !== storedState) {
                alert('Authentication failed: Invalid state');
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            window.history.replaceState({}, document.title, window.location.pathname);
            
            accessToken = code;
            localStorage.setItem('deriv_access_token', accessToken);
            connectWithToken(accessToken);
        }

        function checkStoredToken() {
            const token = localStorage.getItem('deriv_access_token');
            if (token) {
                accessToken = token;
                connectWithToken(token);
            }
        }

        function connectWithToken(token) {
            try {
                ws = new WebSocket(`${OAUTH_CONFIG.ws_url}?app_id=${OAUTH_CONFIG.app_id}`);
                
                ws.onopen = () => {
                    ws.send(JSON.stringify({ authorize: token }));
                };

                ws.onmessage = (msg) => {
                    const data = JSON.parse(msg.data);
                    handleMessage(data);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus(false);
                };

                ws.onclose = () => {
                    isConnected = false;
                    updateConnectionStatus(false);
                };
            } catch (error) {
                console.error('Connection error:', error);
            }
        }

        function handleMessage(data) {
            if (data.error) {
                console.error('API Error:', data.error.message);
                if (data.error.code === 'AuthorizationRequired') {
                    logout();
                }
                return;
            }

            if (data.msg_type === 'authorize') {
                handleAuthorizeSuccess(data.authorize);
            }

            if (data.msg_type === 'balance') {
                stats.currentBalance = data.balance.balance;
                if (stats.initialBalance === 0) {
                    stats.initialBalance = stats.currentBalance;
                    stats.peakBalance = stats.currentBalance;
                }
                updateBalance(stats.currentBalance);
            }

            if (data.msg_type === 'proposal') {
                if (data.proposal && isRunning) {
                    ws.send(JSON.stringify({
                        buy: data.proposal.id,
                        price: data.proposal.ask_price
                    }));
                }
            }

            if (data.msg_type === 'buy') {
                addTradeEntry({
                    contract_id: data.buy.contract_id,
                    stake: currentStake,
                    status: 'pending',
                    time: new Date().toLocaleTimeString()
                });
                
                ws.send(JSON.stringify({
                    proposal_open_contract: 1,
                    contract_id: data.buy.contract_id,
                    subscribe: 1
                }));
            }

            if (data.msg_type === 'proposal_open_contract') {
                const contract = data.proposal_open_contract;
                if (contract.is_sold) {
                    const profit = contract.profit;
                    const won = profit > 0;
                    const exitSpot = contract.exit_tick;
                    const lastDigit = exitSpot ? parseInt(exitSpot.toString().slice(-1)) : null;
                    
                    if (lastDigit !== null) {
                        patternDetector.addResult(lastDigit);
                        updateDigitHeatmap();
                    }
                    
                    updateTradeResult(contract.contract_id, won, profit);
                    updateStats(won, profit);
                    
                    // Strategy callbacks
                    const strategy = strategies[activeStrategy];
                    if (won) {
                        strategy.onWin();
                    } else {
                        strategy.onLoss();
                    }
                    
                    if (isRunning) {
                        checkLimits();
                        if (isRunning) {
                            setTimeout(() => placeTrade(), 2000);
                        }
                    }
                }
            }
        }

        function handleAuthorizeSuccess(authData) {
            userInfo = authData;
            isConnected = true;
            
            document.getElementById('userName').textContent = authData.fullname || authData.loginid;
            document.getElementById('userEmail').textContent = authData.email || authData.loginid;
            document.getElementById('userAvatar').textContent = 
                (authData.fullname || authData.loginid).charAt(0).toUpperCase();
            
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('tradingInterface').classList.remove('hidden');
            
            updateConnectionStatus(true);
            
            ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
        }

        function logout() {
            localStorage.removeItem('deriv_access_token');
            accessToken = null;
            
            if (ws) {
                ws.close();
            }
            
            window.location.reload();
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            document.getElementById('statusDot').style.background = connected ? '#44ff44' : '#ff4444';
            document.getElementById('connectionStatus').textContent = connected ? 'Connected' : 'Disconnected';
            startBtn.disabled = !connected || isRunning;
        }

        function updateBalance(balance) {
            document.getElementById('balance').textContent = `${balance.toFixed(2)}`;
        }

        // Start Bot
        startBtn.addEventListener('click', () => {
            if (activeStrategy === 'manual' && selectedDigits.size === 0) {
                alert('Please select at least one digit');
                return;
            }

            isRunning = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            currentStake = parseFloat(document.getElementById('stake').value);
            strategies[activeStrategy].reset();
            
            placeTrade();
        });

        // Stop Bot
        stopBtn.addEventListener('click', () => {
            isRunning = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
        });

        function placeTrade() {
            if (!isRunning || !isConnected) return;

            const market = document.getElementById('market').value;
            const duration = parseInt(document.getElementById('duration').value);
            const strategy = strategies[activeStrategy];
            const digit = strategy.getNextDigit();

            if (digit === undefined || digit === null) {
                console.error('No digit selected');
                return;
            }

            ws.send(JSON.stringify({
                proposal: 1,
                amount: currentStake,
                basis: 'stake',
                contract_type: 'DIGITDIFF',
                currency: 'USD',
                duration: duration,
                duration_unit: 't',
                symbol: market,
                barrier: digit.toString()
            }));
        }

        function addTradeEntry(trade) {
            const entry = document.createElement('div');
            entry.className = `trade-entry ${trade.status}`;
            entry.id = `trade-${trade.contract_id}`;
            entry.innerHTML = `
                <div>
                    <strong>#${stats.totalTrades + 1}</strong>
                    <span style="margin-left: 10px; color: #666;">${trade.time}</span>
                </div>
                <div>
                    <span>${trade.stake.toFixed(2)}</span>
                    <span style="margin-left: 10px;">${trade.status === 'pending' ? '⏳' : ''}</span>
                </div>
            `;
            document.getElementById('tradesList').insertBefore(entry, 
                document.getElementById('tradesList').firstChild);
        }

        function updateTradeResult(contractId, won, profit) {
            const entry = document.getElementById(`trade-${contractId}`);
            if (entry) {
                entry.className = `trade-entry ${won ? 'win' : 'loss'}`;
                const resultText = won ? 
                    `✅ +${profit.toFixed(2)}` : 
                    `❌ -${Math.abs(profit).toFixed(2)}`;
                entry.querySelector('div:last-child').innerHTML += 
                    `<span style="margin-left: 10px; font-weight: bold;">${resultText}</span>`;
            }
        }

        function updateStats(won, profit) {
            stats.totalTrades++;
            stats.wins += won ? 1 : 0;
            stats.losses += won ? 0 : 1;
            stats.profit += profit;
            stats.currentStreak = won ? 
                (stats.currentStreak > 0 ? stats.currentStreak + 1 : 1) :
                (stats.currentStreak < 0 ? stats.currentStreak - 1 : -1);
            
            // Update peak and drawdown
            if (stats.currentBalance > stats.peakBalance) {
                stats.peakBalance = stats.currentBalance;
            }
            const drawdown = ((stats.peakBalance - stats.currentBalance) / stats.peakBalance) * 100;
            if (drawdown > stats.maxDrawdown) {
                stats.maxDrawdown = drawdown;
            }
            
            // Calculate Sharpe Ratio
            stats.returns.push(profit / currentStake);
            if (stats.returns.length > 20) stats.returns.shift();
            
            updateStatsDisplay();
            updateCharts();
        }

        function updateStatsDisplay() {
            document.getElementById('totalTrades').textContent = stats.totalTrades;
            const winRate = stats.totalTrades > 0 ? (stats.wins / stats.totalTrades * 100).toFixed(1) : 0;
            document.getElementById('winRate').textContent = `${winRate}%`;
            document.getElementById('profit').textContent = 
                stats.profit >= 0 ? `+${stats.profit.toFixed(2)}` : `-${Math.abs(stats.profit).toFixed(2)}`;
            
            // Calculate Sharpe Ratio
            if (stats.returns.length > 1) {
                const mean = stats.returns.reduce((a, b) => a + b, 0) / stats.returns.length;
                const variance = stats.returns.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / stats.returns.length;
                const sharpe = variance > 0 ? (mean / Math.sqrt(variance)) * Math.sqrt(252) : 0;
                document.getElementById('sharpeRatio').textContent = sharpe.toFixed(2);
            }
        }

        function updateCharts() {
            // Update profit chart
            profitData.push(stats.profit);
            tradeLabels.push(stats.totalTrades);
            
            if (profitData.length > 50) {
                profitData.shift();
                tradeLabels.shift();
            }
            
            profitChart.data.labels = tradeLabels;
            profitChart.data.datasets[0].data = profitData;
            profitChart.update();
            
            // Update distribution chart
            distributionChart.data.datasets[0].data = digitFrequency;
            distributionChart.update();
            
            // Update patterns display
            updatePatternsDisplay();
        }

        function updateDigitHeatmap() {
            const maxFreq = Math.max(...digitFrequency);
            document.querySelectorAll('.digit-btn').forEach((btn, index) => {
                const heat = btn.querySelector('.digit-heat');
                if (heat && digitFrequency[index] > 0) {
                    heat.textContent = digitFrequency[index];
                    heat.classList.remove('hidden');
                    const intensity = digitFrequency[index] / maxFreq;
                    heat.style.opacity = 0.5 + intensity * 0.5;
                }
            });
        }

        function updatePatternsDisplay() {
            const patterns = patternDetector.getTopPatterns();
            const patternsList = document.getElementById('patternsList');
            
            patternsList.innerHTML = patterns.map(p => `
                <div class="pattern-row">
                    <div class="pattern-digits">
                        ${p.pattern.split(' ').map(d => `<div class="pattern-digit">${d}</div>`).join('')}
                    </div>
                    <span>→ ${p.nextMostLikely || '?'}</span>
                    <div class="pattern-confidence">${(p.confidence * 100).toFixed(0)}%</div>
                </div>
            `).join('');
        }

        function checkLimits() {
            const maxTrades = parseInt(document.getElementById('maxTrades').value);
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const takeProfit = parseFloat(document.getElementById('takeProfit').value);

            if (stats.totalTrades >= maxTrades) {
                stopBot('Max trades reached');
            } else if (stopLoss > 0 && Math.abs(stats.profit) >= stopLoss && stats.profit < 0) {
                stopBot('Stop loss reached');
            } else if (takeProfit > 0 && stats.profit >= takeProfit) {
                stopBot('Take profit reached');
            }
        }

        function stopBot(reason) {
            isRunning = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            alert(`Bot stopped: ${reason}`);
        }

        // Risk Calculator
        function updateRiskAssessment() {
            const stake = parseFloat(document.getElementById('stake').value);
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const balance = stats.currentBalance || 10000;
            
            const maxLoss = stopLoss || (stake * 10);
            const riskPercent = (maxLoss / balance) * 100;
            
            document.getElementById('maxLoss').textContent = `${maxLoss.toFixed(2)}`;
            document.getElementById('breakEven').textContent = `${(100 / 1.95).toFixed(1)}%`;
            
            // Kelly Criterion
            const winRate = stats.totalTrades > 0 ? stats.wins / stats.totalTrades : 0.5;
            const kellyPercent = winRate > 0 ? ((winRate * 1.95 - 1) / 0.95) * 100 : 0;
            document.getElementById('kellyPercent').textContent = `${Math.max(0, kellyPercent).toFixed(1)}%`;
            
            // Update risk meter
            const riskMeter = document.getElementById('riskMeter');
            riskMeter.style.width = `${Math.min(100, riskPercent * 10)}%`;
            
            if (riskPercent < 5) {
                riskMeter.className = 'risk-fill risk-low';
                riskMeter.textContent = 'Low Risk';
            } else if (riskPercent < 15) {
                riskMeter.className = 'risk-fill risk-medium';
                riskMeter.textContent = 'Medium Risk';
            } else {
                riskMeter.className = 'risk-fill risk-high';
                riskMeter.textContent = 'High Risk';
            }
        }

        // Update risk on input change
        document.getElementById('stake')?.addEventListener('input', updateRiskAssessment);
        document.getElementById('stopLoss')?.addEventListener('input', updateRiskAssessment);

        // Backtest Function
        if (backtestBtn) {
            backtestBtn.addEventListener('click', () => {
                runBacktest();
            });
        }

        function runBacktest() {
            const trials = 1000;
            const winRate = 0.5;
            let btWins = 0;
            let btLosses = 0;
            let btProfit = 0;
            let btMaxDrawdown = 0;
            let btPeak = 0;
            
            for (let i = 0; i < trials; i++) {
                const won = Math.random() < winRate;
                const profit = won ? currentStake * 0.95 : -currentStake;
                
                btProfit += profit;
                if (won) btWins++; else btLosses++;
                
                if (btProfit > btPeak) btPeak = btProfit;
                const drawdown = btPeak - btProfit;
                if (drawdown > btMaxDrawdown) btMaxDrawdown = drawdown;
            }
            
            const btWinRate = (btWins / trials * 100).toFixed(1);
            const btReturn = ((btProfit / (currentStake * trials)) * 100).toFixed(2);
            const btDrawdownPercent = (btMaxDrawdown / currentStake / 10).toFixed(1);
            const profitFactor = btWins > 0 ? (btWins * 0.95) / btLosses : 0;
            
            document.getElementById('btReturn').textContent = `${btReturn}%`;
            document.getElementById('btDrawdown').textContent = `${btDrawdownPercent}%`;
            document.getElementById('btWinRate').textContent = `${btWinRate}%`;
            document.getElementById('btProfitFactor').textContent = profitFactor.toFixed(2);
            
            // Switch to backtest tab
            document.querySelector('[data-tab="backtest"]').click();
        }

        // Initialize
        updateRiskAssessment();
        console.log('Deriv Advanced Trading Bot initialized');
    </script>
</body>
</html>
